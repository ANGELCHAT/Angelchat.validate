// Generated by CoffeeScript 1.7.1
var parser, validator, validatorWrapper, _;

_ = require('underscore');

validator = require('./validator');

parser = require('./parser');

validatorWrapper = function(opts) {
  var rule, validatorMiddleware, _i, _len, _ref;
  opts = opts || {};
  _.defaults(opts, {
    exposeMixedParams: false,
    rules: [],
    asJSON: true
  });
  _ref = opts.rules;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    rule = _ref[_i];
    validator.addRule(rule.name, rule.rule);
  }
  validatorMiddleware = function(req, res, next) {
    req.parse = (function(_this) {
      return function(ruleset) {
        req.files = parser.parse(req.files, ruleset);
        req.p = parser.parse(req.p, ruleset);
        req.query = parser.parse(req.query, ruleset);
        return req.body = parser.parse(req.body, ruleset);
      };
    })(this);
    req.defaults = function(defaults) {
      return req.p = _.defaults(req.p || {}, defaults);
    };
    req.validate = function(rules) {
      var b64, params, response, result;
      params = _.extend({}, req.p, req.files, req.params, req.query, req.body);
      if (opts.exposeMixedParams) {
        req.p = params;
      }
      result = validator.validate(params, rules);
      if (result.length) {
        if (opts.asJSON) {
          response = {
            errors: result
          };
          if (req.query.post_message) {
            response.fromAPI = 1;
            b64 = new Buffer(JSON.stringify(response)).toString('base64');
            response = "<script>window.parent.postMessage('" + b64 + "','*')</script>";
          }
          res.send(response, 400);
          return false;
        } else {
          res.send(result.join('\n'), 400);
          return false;
        }
      } else {
        return true;
      }
    };
    return next();
  };
  return validatorMiddleware;
};

module.exports = validatorWrapper;
